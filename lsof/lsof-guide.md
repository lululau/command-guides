# lsof - 列出打开的文件

---

## 概要 (SYNOPSIS)

`lsof` [ -?abChlnNOPRtUvVX ] [ -A A ] [ -c c ] [ +c c ] [ +|-d d ] [ +|-D D ] [ +|-e s ] [ +|-E ] [ +|-f [cfgGn] ] [ -F [f] ] [ -g [s] ] [ -i [i] ] [ -k k ] [ -K k ] [ +|-L [l] ] [ +|-m m ] [ +|-M ] [ -o [o] ] [ -p s ] [ +|-r [t[m<fmt>]] ] [ -s [p:s] ] [ -S [t] ] [ -T [t] ] [ -u s ] [ +|-w ] [ -x [fl] ] [ +|-X ] [ -z [z] ] [ -Z [Z] ] [ -- ] [names]

---

## 描述 (DESCRIPTION)

`lsof` (list open files) 是一个用于列出被进程打开的文件的工具。一个打开的文件可以是：

*   普通文件
*   目录
*   块特殊文件 (block special file)
*   字符特殊文件 (character special file)
*   正在执行的文本引用 (executing text reference)
*   库
*   流 (stream)
*   网络文件 (例如：Internet 套接字, NFS 文件, UNIX 域套接字)

你可以通过路径选择一个特定的文件或文件系统中的所有文件。

`lsof` 也可以产生可被其他程序解析的输出，详见 `-F` 选项。

此外，`lsof` 可以在重复模式下运行，它会周期性地产生输出，直到被中断信号停止。详见 `+|-r` 选项。

---

## 选项 (OPTIONS)

如果没有指定任何选项，`lsof` 会列出所有活动进程打开的所有文件。

**注意：** 选项可以组合使用，例如 `-abC` 等同于 `-a -b -C`。

### -? -h

显示帮助信息。当 `lsof` 检测到选项错误时，也会显示简短的帮助信息。

**示例:**
```bash
# 显示帮助信息
lsof -?
```

### -a

将多个选择选项的结果进行 "与" (AND) 运算，而不是默认的 "或" (OR) 运算。

**示例:**
```bash
# 列出属于用户 `root` 并且正在使用 UNIX 域套接字的文件
lsof -a -u root -U
```

### -b

避免执行可能阻塞的内核函数，如 `lstat(2)`, `readlink(2)`, 和 `stat(2)`。这在处理有问题的 NFS 挂载点时非常有用。

**示例:**
```bash
# 避免可能阻塞的操作，列出所有打开的文件
lsof -b
```
> **延伸解读:** 关于 `lsof` 为何会阻塞以及如何避免，请参阅 [lsof 的阻塞、超时和内核交互](./lsof-extended-concepts-guide.md#lsof-blocks-timeouts-and-kernel-interaction)。

### -c c

根据命令名称选择进程。`c` 是命令名的起始字符或一个正则表达式。

*   **按名称前缀:**
    ```bash
    # 列出所有以 "sshd" 开头的命令打开的文件
    lsof -c sshd
    ```
*   **使用正则表达式:** 格式为 `/regex/[bix]`。
    *   `b`: 基本正则表达式
    *   `i`: 忽略大小写
    *   `x`: 扩展正则表达式 (默认)
    ```bash
    # 列出所有匹配正则表达式 `^node$` 的命令打开的文件 (忽略大小写)
    lsof -c /^node$/i
    ```
*   **反向选择:** 使用 `^` 排除某个命令。
    ```bash
    # 列出除了 `bash` 之外所有命令打开的文件
    lsof -c ^bash
    ```

### +c w

设置在 `COMMAND` 列中显示命令名称的最大字符数 `w`。如果 `w` 为 0，则显示完整的命令名称。

**示例:**
```bash
# 显示完整的命令名称
lsof +c 0
```
```bash
# 只显示命令名称的前 3 个字符
lsof +c 3
```

### -C

禁止报告来自内核名称缓存的任何路径名组件。

> **延伸解读:** 关于内核名称缓存的更多信息，请参阅 [lsof 的内核名称缓存](./lsof-extended-concepts-guide.md#lsof-kernel-name-cache)。

### +d s

搜索目录 `s` 及其顶层文件和目录的所有打开实例。**注意：** 此选项不会递归下降到子目录。

**示例:**
```bash
# 查找 /etc 目录本身以及 /etc 下第一级文件和目录的打开情况
lsof +d /etc
```

### -d s

根据文件描述符 (FD) 编号来包含或排除文件。`s` 是一个逗号分隔的列表。

*   **cwd**: 当前工作目录
*   **txt**: 程序文本 (代码和数据)
*   **mem**: 内存映射文件
*   **rtd**: 根目录
*   **pd**: 父目录

**示例:**
```bash
# 只显示 FD 为 1 (stdout) 和 2 (stderr) 的文件
lsof -d 1,2

# 显示除了 FD 0, 1, 2 之外的所有文件
lsof -d ^0-2

# 显示当前工作目录被哪些进程使用
lsof -d cwd
```

### +D D

递归地搜索目录 `D` 及其包含的所有文件和子目录的打开实例。**警告：** 在大目录上使用此选项可能会非常慢并消耗大量内存。

**示例:**
```bash
# 递归搜索 /var/log 目录下的所有打开的文件
lsof +D /var/log
```

### -D D

控制 `lsof` 如何使用设备缓存文件。

*   `?`: 报告设备缓存文件的路径。
*   `b`: 构建设备缓存文件。
*   `i`: 忽略设备缓存文件。
*   `r`: 读取设备缓存文件。
*   `u`: 读取并更新设备缓存文件 (默认行为)。

**示例:**
```bash
# 强制 lsof 忽略缓存，直接从内核获取设备信息
lsof -Di
```
> **延伸解读:** 关于设备缓存文件的详细信息，请参阅 [lsof 的设备缓存文件](./lsof-extended-concepts-guide.md#lsof-device-cache-file)。

### +|-e s

(仅 Linux) 免除对指定文件系统 `s` 的可能阻塞的内核调用。`+e` 免除 `stat(2)`, `lstat(2)` 和大多数 `readlink(2)` 调用；`-e` 仅免除 `stat(2)` 和 `lstat(2)`。

**示例:**
```bash
# 当 /mnt/nfs_server 是一个有问题的 NFS 挂载时，避免在其上执行阻塞调用
sudo lsof +e /mnt/nfs_server
```

### +|-E

(仅 Linux) 显示 Linux 管道、UNIX 套接字和伪终端文件的端点信息。

*   `+E`: 显示端点信息以及端点另一端的文件信息。
*   `-E`: 仅显示端点信息。

**示例:**
```bash
# 显示管道两端进程的信息
ps aux | grep some_process | lsof -a -p `pgrep some_process` -d 1 -E
```

### +|-f [cfgGn]

控制路径名参数的解释，并启用或禁用内核文件结构信息的列表。

*   `+f`: 将所有路径名参数视为文件系统名称。
*   `-f`: 将所有路径名参数视为普通文件名。

**示例:**
```bash
# 搜索名为 /dev/sda1 的文件，而不是 /dev/sda1 文件系统上的所有文件
lsof -f -- /dev/sda1
```

### -F f

指定输出格式，用于给其他程序 (如 `awk`, `perl`) 处理。`f` 是一个字符列表，每个字符代表一个字段。

**常用字段:**
*   `p`: PID
*   `c`: 命令名
*   `u`: 用户名
*   `f`: 文件描述符
*   `n`: 文件名
*   `t`: 文件类型
*   `s`: 文件大小
*   `i`: inode 编号
*   `D`: 设备号

**示例:**
```bash
# 以脚本友好的格式输出 PID、用户名、FD 和文件名，并用 null 字符分隔
lsof -F pufn0

# 找出哪个进程在使用 /var/log/syslog 并只打印 PID
lsof -F p /var/log/syslog | grep -v '^p' | xargs
```

### -g [s]

根据进程组 ID (PGID) 选择或排除进程。

**示例:**
```bash
# 列出 PGID 为 123 的进程组中的所有进程打开的文件
lsof -g 123

# 显示所有文件的 PGID 列
lsof -g
```

### -i [i]

根据 Internet 地址选择文件。这是 `lsof` 最强大的功能之一，用于网络诊断。

地址格式: `[46][protocol][@hostname|hostaddr][:service|port]`

*   `4` 或 `6`: 仅 IPv4 或 IPv6。
*   `protocol`: `TCP` 或 `UDP`。
*   `hostname` 或 `hostaddr`: 主机名或 IP 地址。
*   `service` 或 `port`: 服务名 (如 `smtp`) 或端口号。

**示例:**
```bash
# 列出所有 Internet 连接
lsof -i

# 列出所有 TCP 连接
lsof -i TCP

# 列出所有监听在 22 端口的 TCP 连接
lsof -i TCP:22 -sTCP:LISTEN

# 列出所有到主机 example.com 的连接
lsof -i @example.com

# 列出所有到 IP 地址 192.168.1.100，端口为 80 的连接
lsof -i @192.168.1.100:80

# 列出所有 UDP 端口 53 的连接 (DNS)
lsof -i UDP:53

# 列出端口范围 1-1024 的所有连接
lsof -i :1-1024
```

### -K k

在支持的系统上列出进程的任务（线程）。

**示例:**
```bash
# 列出 java 进程及其所有线程打开的文件
lsof -c java -K
```

### -k k

指定内核名称列表文件（内核符号表），代替默认的 `/vmunix` 等。

**示例:**
```bash
# 使用非标准的内核映像文件进行分析
sudo lsof -k /boot/vmlinuz-`uname -r`
```

### -l

禁止将用户 ID (UID) 转换为登录名。当登录名查找缓慢或有问题时，这很有用。

**示例:**
```bash
# 以 UID 而不是用户名显示
lsof -l
```

### +|-L [l]

启用 (`+`) 或禁用 (`-`) 文件链接数的显示。

*   `+L`: 显示链接数 (`NLINK` 列)。
*   `+L1`: 只列出链接数为 1 的文件。
*   `+L0`: (某些版本) 列出链接数为 0 的文件（已被删除但仍被进程持有的文件）。

**示例:**
```bash
# 查找已被删除但仍被进程占用的文件
lsof +L1
```

### -n

禁止将网络号转换为主机名。这可以显著提高 `lsof` 在网络文件查询时的速度。

**示例:**
```bash
# 显示 IP 地址而不是主机名
lsof -i -n
```

### -N

选择 NFS (网络文件系统) 文件。

**示例:**
```bash
# 列出所有打开的 NFS 文件
lsof -N
```

### -o [o]

*   **-o**: 始终显示文件偏移量 (OFFSET)。
*   **-o o**: 定义显示偏移量时使用 `0t` 前缀的十进制数字位数。

**示例:**
```bash
# 始终以偏移量格式显示文件位置
lsof -o
```

### -P

禁止将端口号转换为服务名。这可以略微提高 `lsof` 的速度。

**示例:**
```bash
# 结合 -n，显示 IP 地址和端口号，不做任何名称解析
lsof -i -n -P
```

### -p s

根据进程 ID (PID) 选择或排除进程。

**示例:**
```bash
# 列出 PID 为 1234 的进程打开的文件
lsof -p 1234

# 列出除了 PID 1234 之外的所有进程打开的文件
lsof -p ^1234
```

### +r [t[m<fmt>]]

进入重复模式。`lsof` 会每隔 `t` 秒 (默认 15 秒) 重复执行。这对于监控文件或连接的变化非常有用。

*   `+r`: 当没有任何文件列出时自动退出。
*   `-r`: 无限重复，直到手动中断 (Ctrl-C)。

**示例:**
```bash
# 每 2 秒刷新一次，监控 PID 为 1234 的进程
lsof -p 1234 -r 2

# 持续监控是否有进程监听在 8080 端口，一旦发现就退出
lsof -i :8080 -sTCP:LISTEN +r 1
```

### -R

显示父进程 ID (PPID)。

**示例:**
```bash
# 显示 PPID 列
lsof -R
```

### -s [p:s]

*   **-s**: 始终显示文件大小 (SIZE)。
*   **-s p:s**: 根据协议 (`p`: TCP 或 UDP) 和状态 (`s`) 来选择或排除连接。

**示例:**
```bash
# 始终显示文件大小
lsof -s

# 只显示状态为 LISTEN 的 TCP 连接
lsof -i TCP -s TCP:LISTEN

# 显示除了 ESTABLISHED 状态以外的所有 TCP 连接
lsof -i TCP -s TCP:^ESTABLISHED
```

### -S [t]

为可能阻塞的内核函数设置超时时间（秒）。默认为 15 秒，最小为 2 秒。

**示例:**
```bash
# 将内核函数超时设置为 10 秒
lsof -S 10
```

### -t

以简洁模式输出，只显示 PID，没有表头。常用于将结果通过管道传递给 `kill` 命令。

**示例:**
```bash
# 杀死所有使用某个已删除库文件的进程
kill -9 `lsof -t +L1 /path/to/deleted/library.so`
```

### -T [t]

控制 TCP/TPI 信息的报告。

*   `f`: 套接字选项、状态和 TCP 标志。
*   `q`: 队列长度。
*   `s`: 连接状态 (默认)。
*   `w`: 窗口大小。

**示例:**
```bash
# 显示 TCP 连接的状态和队列长度
lsof -i TCP -T qs
```

### -u s

根据用户名或 UID 选择或排除进程。

**示例:**
```bash
# 列出用户 `nobody` 打开的所有文件
lsof -u nobody

# 列出除了 `root` 用户以外的所有进程打开的文件
lsof -u ^root
```

### -U

选择 UNIX 域套接字文件。

**示例:**
```bash
# 列出所有打开的 UNIX 域套接字
lsof -U
```

### -v

显示 `lsof` 的版本信息。

**示例:**
```bash
# 查看 lsof 版本和编译信息
lsof -v
```

### -X

这是一个特定于操作系统的选项（例如，在 Linux 上跳过 TCP/UDP 文件，在 Solaris 上报告已删除文件的缓存路径）。

**示例 (Solaris):**
```bash
# 报告已删除文件的缓存路径
lsof -X
```

### -z [z]

(仅 Solaris) 处理 Solaris Zones 信息。

**示例:**
```bash
# 列出 myzone 区域中的进程打开的文件
lsof -z myzone
```

### -Z [Z]

(仅 Linux) 处理 SELinux 安全上下文。

**示例:**
```bash
# 列出具有特定安全上下文的进程打开的文件
lsof -Z 'system_u:system_r:httpd_t:*'
```

### --

标记选项的结束。当文件名以 `-` 开头时使用。

**示例:**
```bash
# 列出名为 -myfile.txt 的文件的打开情况
lsof -- -myfile.txt
```

### names

指定要列出的一个或多个文件名或文件系统名。

**示例:**
```bash
# 列出所有打开了 /etc/passwd 文件的进程
lsof /etc/passwd

# 列出 /var/log 文件系统上所有打开的文件
lsof /var/log
```

---

## 输出列说明 (OUTPUT)

`lsof` 的输出包含以下列：

*   **COMMAND**: 进程关联的命令名。
*   **PID**: 进程 ID。
*   **TID**: 任务 (线程) ID (如果支持并启用)。
*   **USER**: 进程所有者的用户名或 UID。
*   **FD**: 文件描述符。
    *   `cwd`: 当前工作目录
    *   `rtd`: 根目录
    *   `txt`: 程序文本 (代码和数据)
    *   `mem`: 内存映射文件
    *   `pd`: 父目录
    *   `1u`: FD 为 1，以读写模式打开 (u)
    *   `2w`: FD 为 2，以写模式打开 (w)
    *   `3r`: FD 为 3，以读模式打开 (r)
    *   锁状态 (`R`, `W`, `u`) 会跟在模式字符后面。
*   **TYPE**: 文件类型 (如 `REG` 普通文件, `DIR` 目录, `CHR` 字符设备, `FIFO`, `PIPE`, `IPv4`, `IPv6`, `UNIX`)。
*   **DEVICE**: 设备的设备号。
*   **SIZE/OFF**: 文件的大小 (字节) 或文件偏移量。
*   **NODE**: 文件的节点号 (inode number)。
*   **NAME**: 文件名、挂载点、网络连接地址等。

---

## AFS

`lsof` 支持识别 AFS (Andrew File System) 文件。然而，由于 AFS 的实现方式，`lsof` 可能难以识别 AFS 文件的所有方面，特别是当 AFS 内核支持是通过动态模块实现时。在这种情况下，`lsof` 可能无法获取计算 AFS 卷节点号所需的信息，导致 `NODE` 列为空白。

`-A A` 选项可用于指定一个备用的名称列表文件，`lsof` 可以从中找到动态模块的内核地址。

---

## 安全性 (SECURITY)

`lsof` 有几个可能引起安全担忧的特性：

1.  **默认权限**: 默认情况下，任何用户都可以使用 `lsof` 列出系统上所有打开的文件。这可以通过在编译时设置 `HASSECURITY` 选项来限制。如果设置了 `HASSECURITY`，则只有 `root` 用户可以查看所有文件；非 `root` 用户只能查看自己进程打开的文件。
2.  **设备缓存文件**: `lsof` 默认会在用户的家目录下创建一个可读写的设备缓存文件 (`.lsof_hostname`)。如果以 `root` 用户身份运行，该文件会创建在 `/` 或 `/root` 目录下。这可以通过在编译时禁用 `HASDCACHE` 选项来阻止。
3.  **内核文件**: `-k` 和 `-m` 选项允许用户指定备用的内核内存文件，`lsof` 会检查用户是否具有读取这些文件的权限。

**临时禁用设备缓存:** 如果对设备缓存文件的安全性有疑问，可以使用 `-Di` 选项临时禁用它。

---

## 文件锁 (LOCKS)

`lsof` 在报告文件锁时存在一些局限性。它使用单个字符来表示锁的状态，这是一种妥协，无法完全展示 UNIX 系统中种类繁多的文件锁。

*   当一个进程对一个文件持有多个字节级别的锁时，`lsof` 只报告它遇到的第一个锁的状态。
*   字节级别的锁（部分文件锁）以小写字母表示 (`r`, `w`, `x`)。
*   整个文件的锁以大写字母表示 (`R`, `W`, `X`)。
*   通常，`lsof` 只能报告本地进程在本地文件上持有的锁。对于 NFS 等远程文件系统上的锁，锁状态通常由服务器端记录和管理。

---

## 给其他程序使用的输出 (OUTPUT FOR OTHER PROGRAMS)

当指定 `-F` 选项时，`lsof` 会生成适合由脚本（如 `awk`, `perl`）或程序处理的格式。每个信息单元都以一个字段标识符开头，并以换行符 (NL) 或 NUL 字符结尾。

*   **进程集 (Process Set)**: 以 `p` (PID) 字段开始。
*   **文件集 (File Set)**: 以 `f` (文件描述符) 字段开始。

使用 `-F?` 可以获取所有可用字段标识符的帮助信息。

**示例:**
```bash
# 选择 PID(p), 命令名(c), 文件描述符(f) 和文件名(n) 字段
# 每个字段以换行符结束
lsof -F pcfn

# 同上，但每个字段以 NUL (\0) 字符结束
lsof -F pcfn0
```

`lsof` 的发行版中包含了一些用于处理这种输出的示例脚本和 C 库，可以作为参考。
